<!DOCTYPE html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="/cookie.js"></script>


<form action="">
  <input id="n" type="hidden" value=""> 
  <input id="m" autocomplete="off" required>
  <input type="submit" value="Send">
</form>

<ul id="messages"></ul>

<script type="text/javascript" charset="utf-8">
  var socket = io();
  var uname = $.cookie("uname");
  var uid = $.cookie("uid");  
  console.log($.cookie());
  console.log($.cookie("uname"));

  socket.emit('join lobby', uname, uid);

  socket.on('join lobby', function(player){
      if (player == uname)
	  return;
      $('#players').append($(`<li id="${player}">`).text(player));
      $('#players').append($(`<button class="challenge" value="${player}">Challenge</button>`));
      $('#players').append("</li>");
  });

  socket.on('leave lobby', function(player){
      $('#' + player).remove();
  });
  
  socket.on('lobby message', function(msg){
      $('#messages').append($('<li>').text(msg));
  });

  socket.on('lobby challenge', function(msg){
      console.log(msg);
      var from = msg.from;
      var to = msg.to;
      console.log(from, to);
      if (to == uname) {
	  $('#' + from).append(`<button class="challenge" value="${from}">Accept</button>`);
      };  
  });
		    
  $(document).ready(function () {
      $('#n').val(uname);
  });

  $('body').on('click', '.challenge', function() {
      var clicked = $(this).val();
      console.log(clicked);
      socket.emit("lobby challenge", {"from":uname, "to":clicked});
  });
  
  $('form').submit(function(){
      socket.emit('lobby message', uname + ": " + $('#m').val());
      console.log($('#m').val());
      $('#m').val('');
      return false;
  });
</script>
